<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta name="description" content="">
<meta name="author" content="Vitalii Kolomiiets, Kyiv, Ukraine, vitaljan@gmail.com">
<title></title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="field">
    <div class="border left"></div>
    <div class="border right"></div>
    <div class="border bottom"></div>
    <div class="ball"></div>
    <div class="bit"></div>
  </div>
</body>
<script>

  const requestInterval = 500; // частота запросов к серверу в мс
  const timeout = 20000; // таймаут в мс

  const pass = () => { // передача мяча на другое поле
    let data = new FormData;
    data.append('player', game.currentPlayer);
    data.append('dx', ball.dx);
    data.append('dy', ball.dy);
    data.append('x', ball.x);
    data.append('width', scr.width);

    fetch('pass.php', {
      method: "POST",
      body: data
    }) 
      .then(function(response){
          if (response.status == 200) {}// удачный ajax запрос
           else {}// неудачный ajax запрос
          return response.json();
      })
      .then(function(response){
        game.currentPlayer = response.player;
        console.log('new player: ', game.currentPlayer);
      })
      .catch(function(error) {
        alert('fetch error!' + error)
      });
    };
    
  const setSizes = ()=>{ // размеры поля, мяча, ракетки
    scr.borderWidth = Math.round(window.innerWidth * 0.03);
    let min = Math.min (window.innerWidth, window.innerHeight);
    scr.width = min;
    scr.height = min;
    document.querySelector('.field').style.width = min + 'px';
    document.querySelector('.field').style.height = min + 'px';
    document.querySelector('.border.left').style.width = scr.borderWidth + 'px';
    document.querySelector('.border.left').style.height = '100%';
    document.querySelector('.border.right').style.height = '100%';
    document.querySelector('.border.right').style.width = scr.borderWidth + 'px';
    document.querySelector('.border.bottom').style.height = scr.borderWidth + 'px';
    ball.radius = Math.round(window.innerWidth * 0.03);
    document.body.style.backgroundPosition = `${scr.borderWidth}px 0;`;
    ball.elem.style.width = 2 * ball.radius + 'px';
    ball.elem.style.height = 2 * ball.radius + 'px';
    bit.elem.style.width = 2 * ball.radius + 'px'
    bit.elem.style.height = 2 * ball.radius + 'px'
  };

  const reset = () => {
    ball.x = Math.round(scr.width / 2 - ball.radius);
    ball.y = Math.round(scr.height / 8 - ball.radius);
    ball.dy = 5;
    ball.dx = 1;
    ball.elem.style.display = 'block';
    ball.elem.style.left = ball.x + 'px';
    ball.elem.style.top = ball.y + 'px';
    game.active = true;
  };

  let scr = {
    borderWidth: 0,
    width: 0,
    height: 0
  }; 

  let bit = {
    x: 0,
    y: 0,
    radius: 20,
    elem: document.querySelector('.bit')
  };

  let mouse = {
    down: false,
    x: 0,
    y: 0,
    oldX: 0,
    oldY: 0
  }

  let ball = {
    x: 0,
    y: 0,
    dx: 0,
    dy: 0,
    radius: 20,
    elem: document.querySelector('.ball')
  };  
  
  let game = {
    id: 0,
    currentPlayer: 0,
    active: false, // мяч перемещается
    ready: false, // мяч реагирует на ракетку
    player: 0,
    player2Login: false
  };

  bit.elem.addEventListener('mousedown', (event)=>{
    event.preventDefault();
    event.stopPropagation();
      mouse.down = true;
      mouse.oldX = event.pageX;
      mouse.oldY = event.pageY;
  });

  window.addEventListener('mouseup', (event)=>{
      mouse.down = false;
  });

  window.addEventListener('mousemove', (event)=>{
    if (mouse.down) {
      let dx = event.pageX - mouse.oldX;
      let dy = event.pageY - mouse.oldY;
      mouse.oldX = event.pageX;
      mouse.oldY = event.pageY;
      bit.x += dx;
      bit.y += dy;
          // проверка выхода за пределы поля
          //****************************************************************************
      bit.elem.style.left = bit.x + 'px';
      bit.elem.style.top = bit.y + 'px';
    }
  });

  
  let waitTime; // счетчик времени ожидания ответа сервера
  let sendRequest = false; // запрос был отправлен при выходе мяча за пределы поля
  
  // начало игры ===============================================

  setSizes(); // уст. размеры объектов
  ball.elem.style.display = 'none';
  
  fetch('begin.php', { // check to login 1 or 2 player
    method: "POST",
  }) 
  .then(function(response){
    if (response.status == 200) {}// удачный ajax запрос
    else {}// неудачный ajax запрос
    return response.json();
  })
  .then(function(json) {
    game.currentPlayer = 1;
    game.player = json.player;
    console.log('i am player: ', game.player);

    let player2Waiting = setInterval (() => { // wait to player 2 connect
      console.log('waiting to 2-nd player connect.....')
      fetch('wait2player.php', { // check to login 1 or 2 player
        method: "POST",
      })
      .then((response)=>{return response.json()})
      .then((response)=>{
        if (response.player2) {
          clearInterval(player2Waiting);
          console.log('player 2 logged in. start game.')
          start();
        };
      })
      .catch (()=>{alert('wait2player.php error' + error)})

    }, requestInterval);

    })
    .catch(function(error) {
        alert('begin.php error!' + error)
    });

const start = () => {
  if (game.player == game.currentPlayer) reset();

  let activeInterval = setInterval(()=>{ // ball moving 
    if (!game.active) return;
    ball.x += ball.dx;
    ball.y += ball.dy;
    
    if (ball.y >= scr.height - 2 * ball.radius - scr.borderWidth) { // мяч коснулся низа
      ball.dy = -ball.dy;
      ball.y = scr.height - 2 * ball.radius  - scr.borderWidth - 1;
    }
    if (ball.x >= scr.width - 2 * ball.radius - scr.borderWidth) { // мяч коснулся правого края
      ball.dx = -ball.dx;
      ball.x = scr.width - 2 * ball.radius - scr.borderWidth - 1;
    }
    if (ball.x <= 2 * ball.radius - scr.borderWidth) { // мяч коснулся левого края
      ball.dx = -ball.dx;
      ball.x = 2 * ball.radius - scr.borderWidth + 1;
    }
    
    ball.elem.style.left = ball.x + 'px';
    ball.elem.style.top = ball.y + 'px';

    if (ball.y <= -ball.radius) { // мяч наполовину ушел за пределы поля
      // отправка данных на сервер
      if (!sendRequest) {
        sendRequest = true;
        pass();
      }
    };

    if (ball.y <= -ball.radius * 2) {// мяч полностью ушел за пределы поля
      game.active = false; // стоп движение мяча
      sendRequest = false;
    };
  }, 10); // activeInterval
    
  let passiveInterval = setInterval(()=>{ // мяч на другом поле
    if (game.active) {
      waitTime = 0;
      return;
    };

    fetch('wait.php', { // проверка передачи мяча назад
        method: "POST",
      }) 
      .then(function(response){
        if (response.status == 200) {}// удачный ajax запрос
        else {}// неудачный ajax запрос
        return response.json();
      })
      .then(function(response) {
        if (response.player == game.player) {
          game.currentPlayer = response.player;
          let k = scr.width / +response.width; // коєф. разницы размера экранов
          ball.dy = Math.round(-response.dy * k);
          ball.dx = Math.round(-response.dx * k);
          ball.y = +ball.radius;
          ball.x = Math.round(+response.x * k);
          console.log(response.width)
          
          // - добавить пересчет координат x пропорционально
          
          game.active = true;
          ball.elem.style.display = "block";
        }
      })
      .catch(function(error) {
          alert('wait error!' + error)
      });

    waitTime += requestInterval;
    if (waitTime >= timeout) {
      clearInterval(passiveInterval);
      console.log('Timeout ---------------');
    }
  }, requestInterval);
};
</script>
</html>